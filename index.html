<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>almartin.ch</title>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-GV9N61X8JR"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            
            gtag('config', 'G-GV9N61X8JR');
            console.log('Google Analytics run');
            </script>
        <!-- almartin.ch site logic-->
        <script>
            const COOKIE_KEY_NAME_IP = 'almartinch-user-ip';
            
            function renderGreeting(ip) {
                document.getElementById("user-custom-greeting").textContent = `welcome ${ip}`;
            }

            async function getCookie(key) {
                if(cookieStore) {
                    return await cookieStore.get(key);
                }
            }
            async function setCookie(key, value) {
                if (cookieStore) {
                    await cookieStore.set(key, value);
                }
            }

            async function getIpInformation() {
                const url = "https://ipinfo.io/json";
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }

                    const json = await response.json();
                    
                    return json;
                } catch (error) {
                    console.log(error.message);
                }
            }

            async function displayUserInformation() {
                let ip;

                const ipCookie = await getCookie(COOKIE_KEY_NAME_IP);
                if(ipCookie) {
                    ip = ipCookie.value;
                }

                const ipInformationJson = await getIpInformation();
                if (ipInformationJson) {
                    console.log(ipInformationJson);
                    const ipIsDifferent = ipInformationJson.ip != ip;
                    if (ipIsDifferent) {
                        ip = ipInformationJson.ip;
                        console.log('New or updated ip.');
                        setCookie(COOKIE_KEY_NAME_IP, ip);
                    }
                }

                renderGreeting(ip);
            }

            displayUserInformation();
            console.log('almartin.ch run');
        </script>

        <link href="styles/style.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <h1>almartin.ch</h1>
        <h2 id="user-custom-greeting">welcome</h2>
        <p>
            <table>
                <caption>
                    Fact
                </caption>
                <tbody>
                    <tr>
                        <td>S</td>
                        <td>U</td>
                        <td>F</td>
                        <td>F</td>
                    </tr>
                    <tr>
                        <td>E</td>
                        <td>R</td>
                        <td>I</td>
                        <td>N</td>
                    </tr>
                    <tr>
                        <td>G</td>
                        <td></td>
                        <td>I</td>
                        <td>S</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>O</td>
                        <td>P</td>
                        <td>T</td>
                    </tr>
                </tbody>
            </table>
        </p>
    </body>
    <footer>
        <p><a href="https://github.com/almartin1911/almartin.ch">source</a></p>
        <address>
            <a href="mailto:amcallejasherrera@gmail.com">amcallejasherrera@gmail.com</a><br />
            <a href="tg:almartinch">@almartinch</a>
        </address>
        <small>
            <p>copyright © 2024 (ál)varo (martín) (c)allejas (h)errera<br />all rights reserved</p>
        </small>
    </footer>
</html>